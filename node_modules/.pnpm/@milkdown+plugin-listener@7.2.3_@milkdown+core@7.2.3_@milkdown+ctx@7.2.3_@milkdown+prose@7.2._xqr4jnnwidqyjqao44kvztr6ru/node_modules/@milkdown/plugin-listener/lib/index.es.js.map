{"version":3,"file":"index.es.js","sources":["../src/index.ts"],"sourcesContent":["/* Copyright 2021, Milkdown by Mirone. */\nimport { createSlice } from '@milkdown/ctx'\nimport type {\n  Ctx,\n  MilkdownPlugin,\n} from '@milkdown/ctx'\nimport {\n  EditorViewReady,\n  InitReady,\n  SerializerReady,\n  prosePluginsCtx,\n  serializerCtx,\n} from '@milkdown/core'\nimport type { Node as ProseNode } from '@milkdown/prose/model'\nimport { Plugin, PluginKey } from '@milkdown/prose/state'\nimport debounce from 'lodash.debounce'\n\n/// The dictionary of subscribers of each event.\nexport interface Subscribers {\n  beforeMount: ((ctx: Ctx) => void)[]\n  mounted: ((ctx: Ctx) => void)[]\n  updated: ((ctx: Ctx, doc: ProseNode, prevDoc: ProseNode | null) => void)[]\n  markdownUpdated: ((ctx: Ctx, markdown: string, prevMarkdown: string | null) => void)[]\n  blur: ((ctx: Ctx) => void)[]\n  focus: ((ctx: Ctx) => void)[]\n  destroy: ((ctx: Ctx) => void)[]\n}\n\n/// The manager of listeners. It provides methods to subscribe to events.\nexport class ListenerManager {\n  private beforeMountedListeners: Array<(ctx: Ctx) => void> = []\n  private mountedListeners: Array<(ctx: Ctx) => void> = []\n  private updatedListeners: Array<(ctx: Ctx, doc: ProseNode, prevDoc: ProseNode | null) => void> = []\n  private markdownUpdatedListeners: Array<(ctx: Ctx, markdown: string, prevMarkdown: string | null) => void> = []\n  private blurListeners: Array<(ctx: Ctx) => void> = []\n  private focusListeners: Array<(ctx: Ctx) => void> = []\n  private destroyListeners: Array<(ctx: Ctx) => void> = []\n\n  /// A getter to get all [subscribers](#interface-subscribers). You should not use this method directly.\n  get listeners(): Subscribers {\n    return {\n      beforeMount: this.beforeMountedListeners,\n      mounted: this.mountedListeners,\n      updated: this.updatedListeners,\n      markdownUpdated: this.markdownUpdatedListeners,\n      blur: this.blurListeners,\n      focus: this.focusListeners,\n      destroy: this.destroyListeners,\n    }\n  }\n\n  /// Subscribe to the beforeMount event.\n  /// This event will be triggered before the editor is mounted.\n  beforeMount = (fn: (ctx: Ctx) => void) => {\n    this.beforeMountedListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the mounted event.\n  /// This event will be triggered after the editor is mounted.\n  mounted = (fn: (ctx: Ctx) => void) => {\n    this.mountedListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the updated event.\n  /// This event will be triggered after the editor state is updated and **the document is changed**.\n  /// The second parameter is the current document and the third parameter is the previous document.\n  updated = (fn: (ctx: Ctx, doc: ProseNode, prevDoc: ProseNode | null) => void) => {\n    this.updatedListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the markdownUpdated event.\n  /// This event will be triggered after the editor state is updated and **the document is changed**.\n  /// The second parameter is the current markdown and the third parameter is the previous markdown.\n  markdownUpdated(fn: (ctx: Ctx, markdown: string, prevMarkdown: string | null) => void) {\n    this.markdownUpdatedListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the blur event.\n  /// This event will be triggered when the editor is blurred.\n  blur(fn: (ctx: Ctx) => void) {\n    this.blurListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the focus event.\n  /// This event will be triggered when the editor is focused.\n  focus(fn: (ctx: Ctx) => void) {\n    this.focusListeners.push(fn)\n    return this\n  }\n\n  /// Subscribe to the destroy event.\n  /// This event will be triggered before the editor is destroyed.\n  destroy(fn: (ctx: Ctx) => void) {\n    this.destroyListeners.push(fn)\n    return this\n  }\n}\n\n/// The ctx key of the listener manager.\n/// You can use `ctx.get(listenerCtx)` to get the [listener manager](#class-listenermanager).\nexport const listenerCtx = createSlice<ListenerManager>(new ListenerManager(), 'listener')\n\n/// The plugin key of the listener prosemirror plugin.\nexport const key = new PluginKey('MILKDOWN_LISTENER')\n\n/// The listener plugin.\nexport const listener: MilkdownPlugin = (ctx) => {\n  ctx.inject(listenerCtx, new ListenerManager())\n\n  return async () => {\n    await ctx.wait(InitReady)\n    const listener = ctx.get(listenerCtx)\n    const { listeners } = listener\n\n    listeners.beforeMount.forEach(fn => fn(ctx))\n\n    await ctx.wait(SerializerReady)\n    const serializer = ctx.get(serializerCtx)\n\n    let prevDoc: ProseNode | null = null\n    let prevMarkdown: string | null = null\n\n    const plugin = new Plugin({\n      key,\n      view: () => {\n        return {\n          destroy: () => {\n            listeners.destroy.forEach(fn => fn(ctx))\n          },\n        }\n      },\n      props: {\n        handleDOMEvents: {\n          focus: () => {\n            listeners.focus.forEach(fn => fn(ctx))\n            return false\n          },\n          blur: () => {\n            listeners.blur.forEach(fn => fn(ctx))\n            return false\n          },\n        },\n      },\n      state: {\n        init: () => {\n          // do nothing\n        },\n        apply: (tr) => {\n          if (!tr.docChanged || tr.getMeta('addToHistory') === false)\n            return\n\n          const handler = debounce(() => {\n            const { doc } = tr\n            if (listeners.updated.length > 0 && (prevDoc == null || !prevDoc.eq(doc))) {\n              listeners.updated.forEach((fn) => {\n                fn(ctx, doc, prevDoc)\n              })\n            }\n\n            if (listeners.markdownUpdated.length > 0 && (prevDoc == null || !prevDoc.eq(doc))) {\n              const markdown = serializer(doc)\n              listeners.markdownUpdated.forEach((fn) => {\n                fn(ctx, markdown, prevMarkdown)\n              })\n              prevMarkdown = markdown\n            }\n\n            prevDoc = doc\n          }, 200)\n\n          return handler()\n        },\n      },\n    })\n    ctx.update(prosePluginsCtx, x => x.concat(plugin))\n\n    await ctx.wait(EditorViewReady)\n    listeners.mounted.forEach(fn => fn(ctx))\n  }\n}\n\nlistener.meta = {\n  package: '@milkdown/plugin-listener',\n  displayName: 'Listener',\n}\n"],"names":["ListenerManager","fn","listenerCtx","createSlice","key","PluginKey","listener","ctx","InitReady","listeners","SerializerReady","serializer","serializerCtx","prevDoc","prevMarkdown","plugin","Plugin","tr","debounce","doc","markdown","prosePluginsCtx","x","EditorViewReady"],"mappings":"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"}